# ============================================================================
# SCRIPT MAESTRO: PASO 3 COMPLETO
# Ejecuta todo el anรกlisis funcional automรกticamente
# ============================================================================

cat("\n")
cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n")
cat("โ              ๐ PASO 3: ANรLISIS FUNCIONAL COMPLETO                  โ\n")
cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n")
cat("\n")

start_time <- Sys.time()

# ============================================================================
# PASO 1: SETUP Y VERIFICACIรN
# ============================================================================

cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n")
cat("PASO 3.1: Setup y Verificaciรณn\n")
cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n")

source("scripts/01_setup_and_verify.R", echo = FALSE)
cat("\nโ PASO 3.1 COMPLETADO\n\n")

# ============================================================================
# PASO 2: TARGET PREDICTION
# ============================================================================

cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n")
cat("PASO 3.2: Target Prediction (Esto puede tardar 5-10 min)\n")
cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n")

step2_result <- tryCatch({
  source("scripts/02_query_targets.R", echo = FALSE)
  TRUE
}, error = function(e) {
  cat("โ ERROR en target prediction:", e$message, "\n")
  FALSE
})

if (step2_result) {
  cat("\nโ PASO 3.2 COMPLETADO\n\n")
} else {
  cat("\nโ๏ธ  PASO 3.2 CON ERRORES (continuando con datos parciales)\n\n")
}

# ============================================================================
# PASO 3: PATHWAY ENRICHMENT
# ============================================================================

cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n")
cat("PASO 3.3: Pathway Enrichment (Esto puede tardar 2-5 min)\n")
cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n")

step3_result <- tryCatch({
  source("scripts/03_pathway_enrichment.R", echo = FALSE)
  TRUE
}, error = function(e) {
  cat("โ ERROR en pathway enrichment:", e$message, "\n")
  FALSE
})

if (step3_result) {
  cat("\nโ PASO 3.3 COMPLETADO\n\n")
} else {
  cat("\nโ๏ธ  PASO 3.3 CON ERRORES (continuando sin pathways)\n\n")
}

# ============================================================================
# PASO 4: NETWORK ANALYSIS
# ============================================================================

cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n")
cat("PASO 3.4: Network Analysis\n")
cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n")

step4_result <- tryCatch({
  source("scripts/04_network_analysis.R", echo = FALSE)
  TRUE
}, error = function(e) {
  cat("โ ERROR en network analysis:", e$message, "\n")
  FALSE
})

if (step4_result) {
  cat("\nโ PASO 3.4 COMPLETADO\n\n")
} else {
  cat("\nโ๏ธ  PASO 3.4 CON ERRORES\n\n")
}

# ============================================================================
# PASO 5: CREAR FIGURAS
# ============================================================================

cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n")
cat("PASO 3.5: Crear Figuras\n")
cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n")

step5_result <- tryCatch({
  source("scripts/05_create_figures.R", echo = FALSE)
  TRUE
}, error = function(e) {
  cat("โ ERROR en creaciรณn de figuras:", e$message, "\n")
  FALSE
})

if (step5_result) {
  cat("\nโ PASO 3.5 COMPLETADO\n\n")
} else {
  cat("\nโ๏ธ  PASO 3.5 CON ERRORES\n\n")
}

# ============================================================================
# PASO 6: CREAR HTML
# ============================================================================

cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n")
cat("PASO 3.6: Crear HTML Viewer\n")
cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n")

step6_result <- tryCatch({
  source("scripts/06_create_HTML.R", echo = FALSE)
  TRUE
}, error = function(e) {
  cat("โ ERROR en HTML:", e$message, "\n")
  FALSE
})

if (step6_result) {
  cat("\nโ PASO 3.6 COMPLETADO\n\n")
}

# ============================================================================
# RESUMEN FINAL
# ============================================================================

end_time <- Sys.time()
duration <- difftime(end_time, start_time, units = "mins")

cat("\n")
cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n")
cat("โ                  ๐ PASO 3 COMPLETADO                                โ\n")
cat("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n")
cat("\n")

cat("โฑ๏ธ  Tiempo total:", round(as.numeric(duration), 1), "minutos\n\n")

cat("๐ PASOS COMPLETADOS:\n")
cat("   ", ifelse(TRUE, "โ", "โ"), " 3.1: Setup\n")
cat("   ", ifelse(step2_result, "โ", "โ"), " 3.2: Target Prediction\n")
cat("   ", ifelse(step3_result, "โ", "โ"), " 3.3: Pathway Enrichment\n")
cat("   ", ifelse(step4_result, "โ", "โ"), " 3.4: Network Analysis\n")
cat("   ", ifelse(step5_result, "โ", "โ"), " 3.5: Figuras\n")
cat("   ", ifelse(step6_result, "โ", "โ"), " 3.6: HTML\n\n")

cat("๐ OUTPUTS:\n")
cat("   โข Targets: data/targets/\n")
cat("   โข Pathways: data/pathways/\n")
cat("   โข Network: data/network/\n")
cat("   โข Figuras: figures/\n")
cat("   โข HTML: PASO_3_ANALISIS_FUNCIONAL.html\n\n")

if (file.exists("PASO_3_ANALISIS_FUNCIONAL.html")) {
  cat("๐ HTML disponible para revisiรณn\n\n")
}

cat("๐ฏ PIPELINE PASO 3 COMPLETADO\n")
cat("   Todo registrado y listo para integrar al pipeline completo\n\n")

