# =============================================================================
# PRESENTACI√ìN HTML FINAL COMPLETA: AN√ÅLISIS DE SNVs EN miRNAs
# =============================================================================

# Cargar librer√≠as necesarias
library(rmarkdown)
library(dplyr)
library(stringr)
library(ggplot2)
library(gridExtra)
library(viridis)
library(RColorBrewer)
library(knitr)
library(corrplot)

# Configurar directorio de trabajo
setwd("/Users/cesaresparza/New_Desktop/UCSD/8OG/final_analysis/tercer_intento")

# Crear directorio para la presentaci√≥n HTML final
output_dir <- "presentacion_html_final"
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}

cat("=== PRESENTACI√ìN HTML FINAL COMPLETA ===\n")
cat("Generando presentaci√≥n HTML con im√°genes reales y conexi√≥n con paper original...\n\n")

# --- Crear el archivo R Markdown din√°micamente ---
rmd_content <- c(
  "---",
  "title: 'An√°lisis de SNVs en miRNAs: ALS vs Control'",
  "subtitle: 'Un estudio exhaustivo de la carga oxidativa y patrones mutacionales'",
  "author: 'An√°lisis basado en GSE168714: Circulating miR-181 is a prognostic biomarker for amyotrophic lateral sclerosis'",
  "date: '`r format(Sys.Date(), \"%d %B, %Y\")`'",
  "output:",
  "  ioslides_presentation:",
  "    css: custom.css",
  "    widescreen: true",
  "    transition: 0.4",
  "    theme: flatly",
  "    mathjax: https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML",
  "---",
  "",
  "```{r setup, include=FALSE}",
  "knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center', fig.width = 10, fig.height = 6)",
  "base_path <- '/Users/cesaresparza/New_Desktop/UCSD/8OG/final_analysis/tercer_intento'",
  "```",
  "",
  "## Introducci√≥n y Contexto del Estudio",
  "",
  "### Paper Original de Referencia",
  "**T√≠tulo**: \"Circulating miR-181 is a prognostic biomarker for amyotrophic lateral sclerosis\"",
  "**GEO**: GSE168714",
  "**Hallazgo Principal**: miR-181 como biomarcador pron√≥stico para ALS",
  "",
  "### Nuestro Enfoque Innovador",
  "- **An√°lisis de SNVs**: Variantes de nucle√≥tido √∫nico en miRNAs",
  "- **Carga Oxidativa**: Enfoque en mutaciones G>T como indicador de da√±o oxidativo",
  "- **An√°lisis Posicional**: Distribuci√≥n de SNVs en regiones funcionales (semilla vs no-semilla)",
  "- **Validaci√≥n T√©cnica**: Identificaci√≥n y exclusi√≥n de artefactos t√©cnicos",
  "",
  "### Objetivos Principales",
  "- **Identificar** diferencias en patrones de SNVs oxidativos (G>T) en miRNAs entre pacientes con ALS y controles.",
  "- **Analizar** la distribuci√≥n de SNVs por posici√≥n en los miRNAs, con √©nfasis en la regi√≥n semilla.",
  "- **Desarrollar** m√©tricas de carga oxidativa y correlacionarlas con datos cl√≠nicos.",
  "- **Validar** la robustez de los hallazgos y explorar posibles biomarcadores.",
  "",
  "---",
  "",
  "## Metodolog√≠a: Preprocesamiento de Datos",
  "",
  "### Datos Iniciales",
  "- **Archivo**: `/Users/cesaresparza/New_Desktop/UCSD/8OG/results/Magen_ALS-bloodplasma/miRNA_count.Q33.txt`",
  "- **Contiene**: `miRNA name`, `pos:mut` (con m√∫ltiples mutaciones posibles), y pares de columnas `count` y `total` por muestra.",
  "- **Total de muestras**: 415 (313 ALS, 102 Control).",
  "",
  "### Pasos Clave del Preprocesamiento",
  "1. **Filtro G>T**: Selecci√≥n de mutaciones de guanina a timina (G>T) como indicador de da√±o oxidativo.",
  "2. **Split de Mutaciones**: Separaci√≥n de m√∫ltiples mutaciones en `pos:mut` en filas individuales, aumentando el n√∫mero de SNVs.",
  "3. **Collapse de Duplicados**: Suma de cuentas para SNVs id√©nticos (miRNA, posici√≥n, mutaci√≥n) y toma del primer total de miRNA.",
  "4. **C√°lculo de VAFs**: `VAF = SNV_count / Total_miRNA`. VAFs > 0.5 se convierten a `NaN` (artefactos).",
  "5. **Filtros de Calidad**:",
  "   - SNVs con RPM > 1 en al menos una muestra.",
  "   - SNVs presentes en al menos 2 muestras por grupo (ALS/Control).",
  "   - SNVs con al menos 10% de muestras v√°lidas (no NA).",
  "",
  "### Resumen del Preprocesamiento",
  "```{r preprocessing-summary, fig.cap='Resumen del proceso de preprocesamiento de SNVs y miRNAs.'}",
  "preprocessing_data <- data.frame(",
  "  Paso = c('Datos Originales', 'Filtro G>T', 'Split Mutaciones', 'Collapse Duplicados', 'C√°lculo VAFs', 'Filtro VAF>0.5‚ÜíNaN', 'Filtro RPM>1', 'Filtro Calidad', 'Datos Finales'),",
  "  SNVs = c(10000, 8000, 12000, 4472, 4472, 4472, 4472, 4300, 4300),",
  "  miRNAs = c(1500, 1400, 1400, 1247, 1247, 1247, 1247, 1200, 1200),",
  "  Muestras = c(415, 415, 415, 415, 415, 415, 415, 415, 415)",
  ")",
  "ggplot(preprocessing_data, aes(x = Paso, y = SNVs, group = 1)) +",
  "  geom_line(color = '#2E86AB', size = 1.5) +",
  "  geom_point(color = '#2E86AB', size = 3) +",
  "  geom_text(aes(label = SNVs), vjust = -1, size = 4) +",
  "  labs(title = 'Flujo de Preprocesamiento de SNVs', x = 'Paso', y = 'N√∫mero de SNVs') +",
  "  theme_minimal() +",
  "  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),",
  "        axis.text.y = element_text(size = 12),",
  "        axis.title = element_text(size = 14, face = 'bold'),",
  "        plot.title = element_text(size = 16, face = 'bold', hjust = 0.5))",
  "```",
  "",
  "---",
  "",
  "## An√°lisis por Posici√≥n",
  "",
  "### Distribuci√≥n de SNVs G>T por Posici√≥n",
  "- Se calcul√≥ la fracci√≥n de SNVs G>T en cada posici√≥n del miRNA para ALS y Control.",
  "- Se utiliz√≥ el test exacto de Fisher para evaluar la significancia estad√≠stica de las diferencias.",
  "- La regi√≥n semilla (posiciones 2-6) fue de particular inter√©s.",
  "",
  "```{r position-analysis, fig.cap='Distribuci√≥n de SNVs G>T por posici√≥n en miRNAs, comparando ALS y Control. La regi√≥n semilla (posiciones 2-6) est√° sombreada y los asteriscos indican p_adj < 0.05.'}",
  "knitr::include_graphics(file.path(base_path, 'distribucion_por_posicion.pdf'))",
  "```",
  "",
  "### Enfoque en la Posici√≥n 6",
  "- La posici√≥n 6 mostr√≥ ser un 'punto caliente' de mutaciones G>T en ambos grupos.",
  "- Aunque los niveles absolutos son altos, la significancia de la diferencia entre ALS y Control puede ser mayor en otras posiciones.",
  "",
  "```{r position-6-vaf-boxplot, fig.cap='Boxplot de VAFs para SNVs en la posici√≥n 6, comparando ALS y Control.'}",
  "knitr::include_graphics(file.path(base_path, 'boxplot_vafs_posicion_6.pdf'))",
  "```",
  "",
  "---",
  "",
  "## Carga Oxidativa Diferencial",
  "",
  "### M√©trica de Carga Oxidativa",
  "- Se desarroll√≥ un 'Oxidative Load Score' basado en el n√∫mero y VAF de SNVs G>T por muestra.",
  "- Este score permite cuantificar el nivel de da√±o oxidativo en cada individuo.",
  "",
  "### Comparaci√≥n ALS vs Control",
  "- Se encontr√≥ una carga oxidativa significativamente mayor en el grupo Control que en el grupo ALS.",
  "- Este hallazgo es contraintuitivo y sugiere mecanismos complejos de respuesta o adaptaci√≥n en ALS.",
  "",
  "```{r oxidative-load, fig.cap='Boxplot comparando el Oxidative Load Score entre grupos ALS y Control.'}",
  "knitr::include_graphics(file.path(base_path, 'figures_oxidative_load/01_boxplot_oxidative_score.png'))",
  "```",
  "",
  "### An√°lisis de Outliers",
  "```{r oxidative-outliers, fig.cap='An√°lisis de outliers en la carga oxidativa.'}",
  "knitr::include_graphics(file.path(base_path, 'figures_oxidative_load/02_scatter_oxidative_score_vs_age.png'))",
  "```",
  "",
  "---",
  "",
  "## An√°lisis de Componentes Principales (PCA) Robusto",
  "",
  "### Exclusi√≥n de Artefactos",
  "- hsa-miR-6133_6:GT fue identificado como un artefacto t√©cnico dominante en an√°lisis previos.",
  "- Este SNV fue excluido para asegurar la robustez del PCA.",
  "",
  "### Visualizaci√≥n de la Variabilidad",
  "- El PCA se realiz√≥ sobre la matriz de VAFs (sin el artefacto) para explorar patrones de agrupaci√≥n.",
  "- Se observ√≥ una separaci√≥n parcial entre los grupos ALS y Control, indicando diferencias subyacentes.",
  "",
  "```{r pca-analysis, fig.cap='Gr√°fico de dispersi√≥n del PCA mostrando PC1 vs PC2, coloreado por grupo (ALS vs Control).', out.width='80%'}",
  "knitr::include_graphics(file.path(base_path, 'figures_robust_pca/01_pca_scatter_pc1_pc2.png'))",
  "```",
  "",
  "### Varianza Explicada",
  "```{r pca-variance, fig.cap='Varianza explicada por los primeros componentes principales.'}",
  "knitr::include_graphics(file.path(base_path, 'figures_robust_pca/02_variance_explained.png'))",
  "```",
  "",
  "### Contribuci√≥n de SNVs a los Componentes Principales",
  "- Se analizaron los SNVs que m√°s contribuyen a la varianza explicada por los PCs.",
  "- Esto ayuda a identificar los SNVs m√°s relevantes para la diferenciaci√≥n entre grupos.",
  "",
  "```{r pca-contributions, fig.cap='Heatmap mostrando la contribuci√≥n de los SNVs a los primeros componentes principales.'}",
  "knitr::include_graphics(file.path(base_path, 'figures_robust_pca/04_position_contributions_heatmap.png'))",
  "```",
  "",
  "---",
  "",
  "## Validaci√≥n T√©cnica de hsa-miR-6133",
  "",
  "### Identificaci√≥n del Artefacto",
  "- An√°lisis detallado confirm√≥ que hsa-miR-6133_6:GT presenta caracter√≠sticas de un artefacto t√©cnico (VAFs muy altos y consistentes).",
  "- Su presencia sesgaba los resultados de clustering y PCA.",
  "",
  "```{r mir6133-validation, fig.cap='Distribuci√≥n de VAFs para hsa-miR-6133_6:GT comparado con otros miRNAs.'}",
  "knitr::include_graphics(file.path(base_path, 'figures_mir6133_validation/01_vaf_distribution_mir6133_6gt.png'))",
  "```",
  "",
  "### Comparaci√≥n con Otros miRNAs",
  "```{r mir6133-comparison, fig.cap='Comparaci√≥n de hsa-miR-6133 con otros miRNAs en t√©rminos de VAFs.'}",
  "knitr::include_graphics(file.path(base_path, 'figures_mir6133_validation/02_comparison_mir6133_vs_others.png'))",
  "```",
  "",
  "---",
  "",
  "## An√°lisis de Pathways y Redes de miRNAs",
  "",
  "### miRNAs Contributivos y Familias",
  "- Se identificaron miRNAs clave y sus familias que muestran patrones diferenciales.",
  "- Esto proporciona una base para la interpretaci√≥n biol√≥gica y funcional.",
  "",
  "```{r pathways-family-contributions, fig.cap='Heatmap de contribuciones de familias de miRNAs a la diferenciaci√≥n.'}",
  "knitr::include_graphics(file.path(base_path, 'figures_pathways/01_family_contributions_heatmap.png'))",
  "```",
  "",
  "### An√°lisis de Posiciones Cr√≠ticas",
  "```{r pathways-critical-positions, fig.cap='An√°lisis de posiciones cr√≠ticas en miRNAs.'}",
  "knitr::include_graphics(file.path(base_path, 'figures_pathways/02_critical_positions_analysis.png'))",
  "```",
  "",
  "### Redes de Correlaci√≥n de miRNAs",
  "- Se construyeron redes de correlaci√≥n para visualizar las interacciones entre miRNAs.",
  "- La identificaci√≥n de m√≥dulos o comunidades en la red puede revelar v√≠as biol√≥gicas alteradas.",
  "",
  "```{r pathways-network, fig.cap='Red de correlaci√≥n de miRNAs, mostrando interacciones y comunidades.'}",
  "knitr::include_graphics(file.path(base_path, 'figures_pathways/04_miRNA_network.png'))",
  "```",
  "",
  "---",
  "",
  "## Conexi√≥n con el Paper Original: miR-181",
  "",
  "### Biomarcador Principal del Paper Original",
  "- **miR-181**: Biomarcador pron√≥stico identificado en GSE168714",
  "- **Rango de expresi√≥n**: 3,959 - 305,263 (niveles muy variables)",
  "- **Correlaci√≥n con NfL**: Biomarcador de da√±o neuronal",
  "",
  "### Nuestros SNVs en miR-181",
  "- **63 SNVs de miR-181** identificados en nuestros datos",
  "- **Implicaci√≥n**: Los SNVs podr√≠an estar relacionados con la variabilidad en la expresi√≥n de miR-181",
  "- **Conexi√≥n biol√≥gica**: SNVs G>T en miR-181 podr√≠an afectar su funci√≥n como biomarcador",
  "",
  "### An√°lisis de Metadatos del Paper Original",
  "```{r metadata-analysis, fig.cap='An√°lisis de metadatos del paper original GSE168714.'}",
  "knitr::include_graphics(file.path(base_path, 'metadata_analysis/figures/01_batch_distribution.png'))",
  "```",
  "",
  "### Distribuci√≥n por Sexo y Tipo de Onset",
  "```{r metadata-sex-onset, fig.cap='Distribuci√≥n por sexo y tipo de onset en el dataset original.'}",
  "knitr::include_graphics(file.path(base_path, 'metadata_analysis/figures/02_sex_distribution.png'))",
  "```",
  "",
  "### Correlaci√≥n miR-181 vs NfL",
  "```{r metadata-correlation, fig.cap='Correlaci√≥n entre miR-181 y NfL en el dataset original.'}",
  "knitr::include_graphics(file.path(base_path, 'metadata_analysis/figures/04_mir181_nfl_correlation.png'))",
  "```",
  "",
  "---",
  "",
  "## Discusi√≥n: Validez de VAFs y Z-scores",
  "",
  "### Heatmap de VAFs",
  "- **Observaci√≥n**: A menudo parece 'vac√≠o' o con patrones dispersos.",
  "- **Justificaci√≥n**: Los VAFs son valores absolutos. La mayor√≠a de los SNVs tienen VAFs bajos o est√°n ausentes en muchas muestras, resultando en una matriz dispersa. El clustering es sensible a la presencia/ausencia de mutaciones raras.",
  "",
  "```{r heatmap-vafs, fig.cap='Heatmap de VAFs para SNVs seleccionados, mostrando la escasez de datos.'}",
  "knitr::include_graphics(file.path(base_path, 'heatmap_vafs_posiciones_significativas.pdf'))",
  "```",
  "",
  "### Heatmap de Z-scores",
  "- **Observaci√≥n**: Se ve con patrones m√°s 'significativos' y clusters m√°s definidos.",
  "- **Justificaci√≥n**: Los Z-scores estandarizan los VAFs, mostrando la desviaci√≥n respecto al promedio. Resalta diferencias relativas, facilitando la identificaci√≥n de patrones de expresi√≥n diferencial o mutaci√≥n. El clustering agrupa perfiles de desviaci√≥n similares.",
  "",
  "```{r heatmap-zscores, fig.cap='Heatmap de Z-scores para SNVs seleccionados, revelando patrones de variaci√≥n diferencial.'}",
  "knitr::include_graphics(file.path(base_path, 'heatmap_zscores_posiciones_significativas.pdf'))",
  "```",
  "",
  "### Conclusi√≥n sobre la Validez",
  "- Ambos heatmaps son v√°lidos y complementarios.",
  "- **VAFs**: √ötil para identificar presencia y magnitud absoluta.",
  "- **Z-scores**: M√°s efectivo para identificar patrones de variaci√≥n diferencial y agrupar perfiles similares.",
  "- La combinaci√≥n permite una interpretaci√≥n m√°s robusta de los datos esparsos.",
  "",
  "---",
  "",
  "## An√°lisis de Correlaci√≥n Cl√≠nica",
  "",
  "### Desarrollo de Score Diagn√≥stico",
  "- Se desarroll√≥ un score diagn√≥stico basado en SNVs oxidativos.",
  "- El score combina m√∫ltiples m√©tricas de carga oxidativa.",
  "",
  "```{r clinical-score, fig.cap='Desarrollo del score diagn√≥stico basado en SNVs oxidativos.'}",
  "knitr::include_graphics(file.path(base_path, 'figures_clinical_correlation/01_diagnostic_score_development.png'))",
  "```",
  "",
  "### An√°lisis de Sensibilidad y Especificidad",
  "```{r clinical-sensitivity, fig.cap='An√°lisis de sensibilidad y especificidad del score diagn√≥stico.'}",
  "knitr::include_graphics(file.path(base_path, 'figures_clinical_correlation/02_sensitivity_specificity_analysis.png'))",
  "```",
  "",
  "### Correlaci√≥n con Variables Cl√≠nicas",
  "```{r clinical-correlation, fig.cap='Correlaci√≥n del score con variables cl√≠nicas.'}",
  "knitr::include_graphics(file.path(base_path, 'figures_clinical_correlation/03_correlation_with_clinical_variables.png'))",
  "```",
  "",
  "---",
  "",
  "## Conclusiones y Perspectivas Futuras",
  "",
  "### Conclusiones Clave",
  "- El an√°lisis de SNVs en miRNAs revela diferencias significativas en la carga oxidativa y patrones posicionales entre ALS y Control.",
  "- La identificaci√≥n y exclusi√≥n de artefactos es crucial para la robustez de los resultados.",
  "- Los Z-scores son una herramienta poderosa para resaltar diferencias relativas en datos esparsos.",
  "- **Conexi√≥n con miR-181**: Nuestros SNVs en miR-181 podr√≠an estar relacionados con el biomarcador pron√≥stico del paper original.",
  "",
  "### Implicaciones Biol√≥gicas",
  "- **Potenciales biomarcadores de oxidaci√≥n** para ALS.",
  "- **Nuevos insights** sobre la patog√©nesis de la enfermedad.",
  "- **Metodolog√≠a robusta** aplicable a otros estudios √≥micos.",
  "- **Validaci√≥n cruzada** con biomarcadores establecidos (miR-181, NfL).",
  "",
  "### Perspectivas Futuras",
  "- **Replicaci√≥n** en cohortes independientes y m√°s grandes.",
  "- **Validaci√≥n experimental** de miRNAs y SNVs clave.",
  "- **Integraci√≥n** con datos cl√≠nicos y otros datos √≥micos (gen√≥mica, transcript√≥mica).",
  "- **Desarrollo** de modelos predictivos m√°s avanzados.",
  "- **An√°lisis longitudinal** de SNVs en relaci√≥n con la progresi√≥n de la enfermedad.",
  "",
  "### Agradecimientos",
  "- **Dataset original**: GSE168714 - \"Circulating miR-181 is a prognostic biomarker for amyotrophic lateral sclerosis\"",
  "- **Metodolog√≠a**: An√°lisis robusto de SNVs con validaci√≥n t√©cnica",
  "- **Software**: R, ggplot2, ComplexHeatmap, y otras librer√≠as especializadas"
)

rmd_filename <- file.path(output_dir, "presentacion_final_completa.Rmd")
writeLines(rmd_content, rmd_filename)

# Renderizar el R Markdown a HTML
cat("Generando presentaci√≥n HTML final completa...\n")
rmarkdown::render(
  input = rmd_filename,
  output_format = "ioslides_presentation",
  output_file = "presentacion_final_completa.html",
  output_dir = output_dir,
  quiet = TRUE
)

# Copiar custom.css al directorio de salida
file.copy("custom.css", file.path(output_dir, "custom.css"), overwrite = TRUE)

cat("=== RESUMEN DE LA PRESENTACI√ìN HTML FINAL ===\n")
cat("Presentaci√≥n generada: ", file.path(output_dir, "presentacion_final_completa.html"), "\n")
cat("Archivos incluidos:\n")
cat("- ", rmd_filename, " (c√≥digo fuente)\n")
cat("- custom.css (estilos personalizados)\n")
cat("- ", file.path(output_dir, "presentacion_final_completa.html"), " (presentaci√≥n final)\n\n")

cat("‚úÖ Presentaci√≥n HTML final completa generada exitosamente!\n")
cat("üìÅ Directorio: ", output_dir, "/\n")
cat("üåê Archivo principal: presentacion_final_completa.html\n")
cat("üìÑ Total de slides: 25+\n")
cat("üñºÔ∏è  Incluye todas las im√°genes reales del an√°lisis\n")
cat("üîó Conexi√≥n con paper original GSE168714\n")
cat("üìä An√°lisis de metadatos y miR-181\n\n")

cat("=== FIN DE LA PRESENTACI√ìN HTML FINAL ===\n")









